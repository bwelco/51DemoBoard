C51 COMPILER V9.52.0.0   MAIN                                                              08/24/2015 23:09:53 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include <myhead.h>
   2          
   3          // int T  温度
   4          // int R 湿度  使用gettemperature();后可以打印出温湿度的值
   5          int recv_lock = 0;
   6          unsigned char flag1 = 0,flag2 = 0,temp1,temp2;
   7          char strbuf[50] = {0};
   8          int posi = 0;
   9          int temp_lock = 0;
  10          int card_id_posi = 0;
  11          char cardid[50] = {0};
  12          
  13          char tab1[30];
  14          char tab2[30];
  15          
  16          int temp_max = 100;
  17          int temp_min = -40;
  18          int light_max = 99999;
  19          int light_min = -1;
  20          int humi_max = 100;
  21          int humi_min = 0;
  22          
  23          int temp_max_flag = 0;
  24          int temp_min_flag = 0;
  25          
  26          int light_max_flag = 0;
  27          int light_min_flag = 0;
  28          
  29          int humi_max_flag = 0;
  30          int humi_min_flag = 0;
  31          
  32          int redlight_flag = 0;
  33          int sound_flag = 0;
  34          
  35          int steer_flag = 0;
  36          int card_flag = 0;
  37          char setcard_buf[50];
  38          int steer_degree = 0;
  39          
  40          int lock_2 = 0;
  41          int lock_3 = 0;
  42          int card_flag_c = 0;
  43          int main()
  44          {       
  45   1              bpm = 0;
  46   1      
  47   1          system_init();
  48   1              
  49   1              sendstr("Programme starting...\n");
  50   1              
  51   1              while(1)
  52   1              {               
  53   2                      while(recv_lock != 1)
  54   2                      {
  55   3                              if(redlight_flag == 1)
C51 COMPILER V9.52.0.0   MAIN                                                              08/24/2015 23:09:53 PAGE 2   

  56   3                              {
  57   4                                      if(redlight == 1)
  58   4                                          bpm = 1;
  59   4                                      else
  60   4                                              bpm = 0;
  61   4                              }
  62   3                              
  63   3                              if(sound_key == 0 && sound_flag == 1)
  64   3                              {
  65   4                                      //sound_delay();
  66   4                                      if(sound_key == 0)
  67   4                                      {
  68   5                                              out1 = 0;
  69   5                                              sprintf(send_message, "out1 = 0\n");
  70   5                                              sendstr(send_message);
  71   5                                              sound_key = 1;
  72   5                                      }
  73   4                  }
  74   3                              
  75   3                              if(temp_min_flag == 1 && temp_min > (int)TH)
  76   3                              {
  77   4                                      out1 = 0;
  78   4                                      sprintf(send_message, "out1 = 0\n");    //温度 < 下线值  输出1开
  79   4                                      sendstr(send_message);
  80   4                              }
  81   3                              
  82   3                              
  83   3                              if(temp_max_flag == 1 && (int)TH > temp_max)
  84   3                              {
  85   4                                      out1 = 1;
  86   4                                      sprintf(send_message, "out1 = 1\n");    //温度 > 上限值  输出1关
  87   4                                      sendstr(send_message);
  88   4                              }
  89   3                              
  90   3                              if(humi_max_flag == 1 && (int)RH > humi_max)
  91   3                              {
  92   4                                      out2 = 0;
  93   4                                      sprintf(send_message, "out2 = 0\n");    //湿度 > 上限值  输出2开
  94   4                                      sendstr(send_message);
  95   4                              }
  96   3                              
  97   3                              if(humi_min_flag == 1 && (int)RH < humi_min)
  98   3                              {
  99   4                                      out2 = 1;
 100   4                                      sprintf(send_message, "out2 = 1\n");    //湿度 < 下限值  输出2关
 101   4                                      sendstr(send_message);
 102   4                              }
 103   3                              
 104   3                              if(light_min_flag == 1 && light_compare < light_min)
 105   3                              {
 106   4                                      out3 = 0;
 107   4                                      sprintf(send_message, "out3 = 0\n");    //光照 < 下限值  输出3开
 108   4                                      sendstr(send_message);
 109   4                              }
 110   3                              
 111   3                              if(light_max_flag == 1 && light_compare > light_max)
 112   3                              {
 113   4                                      out3 = 1;
 114   4                                      sprintf(send_message, "out3 = 1\n");    //光照 > 上限值  输出3关
 115   4                                      sendstr(send_message);
 116   4                              }
 117   3                              
C51 COMPILER V9.52.0.0   MAIN                                                              08/24/2015 23:09:53 PAGE 3   

 118   3                              if(card_flag_c == 1)
 119   3                              {
 120   4                                      android_control_lcd1602();
 121   4                                      card_flag_c = 0;
 122   4                              }
 123   3                              if(flag2 == 1)
 124   3                              {
 125   4                                      if(android_flag == 1)
 126   4                                      {
 127   5                                              android_control_lcd1602();
 128   5                                              card_flag_c = 1;
 129   5                                      }
 130   4                                      if(steer_flag == 1 && card_flag == 1 && 
 131   4                                              (strcmp(cardid, setcard_buf) == 0))
 132   4                                      {               
 133   5                                              while(lock_2 == 1);
 134   5                                              lock_3 = 1;
 135   5                                              
 136   5                                              bpm = 1;
 137   5                                              stop_interrupt();
 138   5                                              pwm_value = turn(steer_degree);
 139   5                                              InitSteering();
 140   5                                              interrupt1_lock = 1;
 141   5                                              interrupt3_lock = 1;
 142   5                                              
 143   5                                              delay_ms_steering(1000);
 144   5                                              delay_ms_steering(1000);
 145   5                                              delay_ms_steering(500);
 146   5                                              StopSteering();
 147   5                                              start_interrupt();
 148   5                                              sendstr("OK\n");
 149   5                                              interrupt1_lock = 0;
 150   5                                              interrupt3_lock = 0;
 151   5                                              bpm = 0;
 152   5                                              stop_interrupt();
 153   5                                              
 154   5                                              lock_3 = 0;
 155   5                      }
 156   4                                      else
 157   4                                      {
 158   5                                              sprintf(send_message, "card id = %s\n", cardid);
 159   5                                          sendstr(send_message);
 160   5                                      }
 161   4                                      stop_interrupt();
 162   4                                      Delay500ms();
 163   4                                      Delay500ms();
 164   4                                      
 165   4                                      while(S2CON&S2RI)
 166   4                                      {
 167   5                                              S2CON&=~S2RI;
 168   5                                              temp2=S2BUF;
 169   5                                      }
 170   4                                      flag2 = 0;
 171   4                                      start_interrupt();
 172   4                                      
 173   4                              }
 174   3              }
 175   2                      handle_message();
 176   2                      recv_lock = 0;
 177   2                      
 178   2              }
 179   1      }
C51 COMPILER V9.52.0.0   MAIN                                                              08/24/2015 23:09:53 PAGE 4   

 180          
 181          void sound_delay(unsigned int z)
 182          {                                                                                                                                                                                          
 183   1          unsigned int i,j;
 184   1          for(i=z;i>0;i--)
 185   1              for(j=110;j>0;j--);
 186   1      } 
 187          
 188          
 189          
 190          /************串口1中断处理函数*********
 191          void Uart() interrupt 4 using 1
 192          {
 193              unsigned char recv_data;
 194                  if(RI == 1)
 195                  {
 196                      recv_data = SBUF;
 197                          RI = 0;
 198                  
 199                          if(recv_data != '*')
 200                          {
 201                                  strbuf[posi++] = recv_data;     
 202                          }
 203                          else
 204                          {
 205                                  temp_lock = 0;
 206                                  strbuf[posi] = '\0';
 207                              recv_lock = 1;
 208                                  posi = 0;
 209                                  //while(temp_lock == 0);
 210                                  //handle_message();
 211                          }
 212                  }
 213          
 214          }
 215          /*********** 串口2中断处理函数 *****
 216          void UART_2Interrupt(void) interrupt 8
 217          {
 218                  unsigned char recv_data;
 219                  unsigned char a;
 220                  
 221              if(S2CON&S2RI)
 222                  {
 223                          bmp = 1;
 224                          recv_data = S2BUF;
 225                          S2CON&=~S2RI;
 226                  
 227                          if(recv_data != 0x03)
 228                          {
 229                                  cardid[card_id_posi++] = recv_data;     
 230                          }
 231                          else
 232                          {
 233                                  cardid[card_id_posi++] = '\0';
 234                                  card_id_posi = 0;       
 235                                  flag2 = 1;
 236                          }
 237                  } 
 238          }
 239          
 240          void UART_2Interrupt(void) interrupt 8
 241          {
C51 COMPILER V9.52.0.0   MAIN                                                              08/24/2015 23:09:53 PAGE 5   

 242                  if(S2CON&S2RI)
 243                  {
 244                          S2CON&=~S2RI;
 245                          temp2=S2BUF;
 246                          if(temp2 == 0x02)
 247                          {
 248                                  card_id_posi = 0;
 249                                  
 250                  }
 251                          if(temp2 != 0x02 && temp2 != 0x03)
 252                          {
 253                                  cardid[card_id_posi++] = temp2;
 254                          }
 255                          if(temp2 == 0x03)
 256                          {
 257                                  flag2 = 1;
 258                                  cardid[card_id_posi - 2] = '\0';
 259                          }
 260                  } 
 261          }
 262          
 263          */


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    898    ----
   CONSTANT SIZE    =    101    ----
   XDATA SIZE       =    262    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
